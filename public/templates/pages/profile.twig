<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }} - Perfil de Usuario</title>
    
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="/assets/lib/twbs/bootstrap/dist/css/bootstrap.min.css">
    
    <!-- Estilos personalizados -->
    <link rel="stylesheet" href="/assets/styles/generic.css">
    <link rel="stylesheet" href="/assets/styles/components/navbar.css">
    <link rel="stylesheet" href="/assets/styles/components/footer.css">
    <link rel="stylesheet" href="/assets/styles/pages/profile.css">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="/assets/lib/fontawesome/fontawesome-free-6.4.0-web/css/all.min.css">
    
    <!-- Animate.css y AOS -->
    <link rel="stylesheet" href="/assets/lib/animate.css/animate.min.css">
    <link rel="stylesheet" href="/assets/lib/aos/aos.css">    
</head>
<body>
    <header>
        {% include 'components/navbar.twig' %}
    </header>

    <main>
        <!-- Cabecera del perfil -->
        <section class="profile-header animate__animated animate__fadeIn">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-lg-3 col-md-4 text-center">
                        <div class="rounded-circle overflow-hidden mx-auto mb-3" style="width: 200px; height: 200px;">
                            <img src="{{ user.avatar_url|default('/assets/users/default-avatar.png') }}" 
                                 alt="Avatar de {{ user.username }}" 
                                 class="w-100 h-100 object-fit-cover">
                        </div>
                    </div>
                    <div class="col-lg-9 col-md-8">
                        <h1 class="display-4">{{ user.username }}</h1>
                        <p class="text-primary fs-5 mb-2">
                            <i class="fas fa-envelope me-2"></i>{{ user.email|default('No disponible') }}
                        </p>
                        <p class="lead">{{ user.bio|default('Este usuario todavía no ha añadido una biografía.') }}</p>
                        <div class="d-flex flex-wrap mb-3">
                            <span class="badge bg-primary me-2 mb-2 p-2"><i class="fas fa-calendar-alt me-1"></i> Miembro desde {{ user.created_at|date("d/m/Y") }}</span>
                            <span class="badge bg-success me-2 mb-2 p-2"><i class="fas fa-upload me-1"></i> {{ user.contributions|default(0) }} Contribuciones</span>
                            <span class="badge bg-info me-2 mb-2 p-2"><i class="fas fa-map-marker-alt me-1"></i> {{ user.location|default('Sin ubicación') }}</span>
                        </div>
                        {% if is_own_profile %}
                        <div class="mt-3">
                            <button class="btn btn-outline-light" data-bs-toggle="modal" data-bs-target="#editProfileModal">
                                <i class="fas fa-edit me-1"></i> Editar perfil
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </section>

        <!-- Contenido del perfil -->
        <div class="container py-4">
            <div class="row">
                <div class="col-md-12">
                    <div class="card bg-dark text-light border-secondary">
                        <div class="card-header">
                            <!-- Pestañas de navegación -->
                            <ul class="nav nav-tabs card-header-tabs" id="profileTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="activity-tab" data-bs-toggle="tab" 
                                            data-bs-target="#activity" type="button" role="tab" 
                                            aria-controls="activity" aria-selected="true">
                                        <i class="fas fa-chart-line me-1"></i> Actividad
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="favorites-tab" data-bs-toggle="tab" 
                                            data-bs-target="#favorites" type="button" role="tab" 
                                            aria-controls="favorites" aria-selected="false">
                                        <i class="fas fa-heart me-1"></i> Favoritos
                                    </button>
                                </li>
                                {% if is_own_profile %}
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="settings-tab" data-bs-toggle="tab" 
                                            data-bs-target="#settings" type="button" role="tab" 
                                            aria-controls="settings" aria-selected="false">
                                        <i class="fas fa-cog me-1"></i> Configuración
                                    </button>
                                </li>
                                {% endif %}
                            </ul>
                        </div>
                        <div class="card-body">
                            <!-- Contenido de las pestañas -->
                            <div class="tab-content profile-tabs-content" id="profileTabsContent">
                                
                                <!-- Pestaña de Actividad -->
                                <div class="tab-pane fade show active profile-tab-content" id="activity" role="tabpanel" aria-labelledby="activity-tab">
                                    <h3 class="mb-4">Actividad reciente</h3>
                                    
                                    <div class="row row-cols-1 row-cols-md-2 g-4">
                                        <div class="col">
                                            <div class="card h-100 shadow-sm" data-aos="fade-up">
                                                <div class="card-header d-flex justify-content-between align-items-center bg-primary text-white">
                                                    <span><i class="fas fa-trophy me-2"></i> Estadísticas</span>
                                                </div>
                                                <div class="card-body bg-white text-dark">
                                                    <div class="row">
                                                        <div class="col-6 mb-4 text-center">
                                                            <div class="p-3 rounded-circle mx-auto mb-2" style="width: 70px; height: 70px; background-color: rgba(13, 110, 253, 0.1);">
                                                                <i class="fas fa-heart text-primary fa-2x"></i>
                                                            </div>
                                                            <h3 class="text-primary">{{ user.favorites_count|default(0) }}</h3>
                                                            <p class="text-muted">Favoritos</p>
                                                        </div>
                                                        <div class="col-6 mb-4 text-center">
                                                            <div class="p-3 rounded-circle mx-auto mb-2" style="width: 70px; height: 70px; background-color: rgba(25, 135, 84, 0.1);">
                                                                <i class="fas fa-comment text-success fa-2x"></i>
                                                            </div>
                                                            <h3 class="text-success">{{ user.comments_count|default(0) }}</h3>
                                                            <p class="text-muted">Comentarios</p>
                                                        </div>
                                                        <div class="col-6 text-center">
                                                            <div class="p-3 rounded-circle mx-auto mb-2" style="width: 70px; height: 70px; background-color: rgba(13, 202, 240, 0.1);">
                                                                <i class="fas fa-thumbs-up text-info fa-2x"></i>
                                                            </div>
                                                            <h3 class="text-info">{{ user.likes_count|default(0) }}</h3>
                                                            <p class="text-muted">Me gusta</p>
                                                        </div>
                                                        <div class="col-6 text-center">
                                                            <div class="p-3 rounded-circle mx-auto mb-2" style="width: 70px; height: 70px; background-color: rgba(255, 193, 7, 0.1);">
                                                                <i class="fas fa-upload text-warning fa-2x"></i>
                                                            </div>
                                                            <h3 class="text-warning">{{ user.contributions|default(0) }}</h3>
                                                            <p class="text-muted">Contribuciones</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="col">
                                            <div class="card h-100 shadow-sm" data-aos="fade-up" data-aos-delay="100">
                                                <div class="card-header d-flex justify-content-between align-items-center bg-primary text-white">
                                                    <span><i class="fas fa-history me-2"></i> Últimas acciones</span>
                                                </div>
                                                <div class="card-body p-0 bg-white">
                                                    <ul class="list-group list-group-flush">
                                                        {% if user_actions is defined and user_actions|length > 0 %}
                                                            {% for action in user_actions %}
                                                            <li class="list-group-item border-bottom d-flex align-items-center">
                                                                <div class="me-3">
                                                                    <span class="badge rounded-pill bg-{{ action.color|default('primary') }} p-2">
                                                                        <i class="fas fa-{{ action.icon|default('check') }}"></i>
                                                                    </span>
                                                                </div>
                                                                <div class="flex-grow-1">
                                                                    <div>{{ action.description }}</div>
                                                                    <small class="text-muted">{{ action.date }}</small>
                                                                </div>
                                                            </li>
                                                            {% endfor %}
                                                        {% else %}
                                                        <li class="list-group-item d-flex align-items-center">
                                                            <div class="me-3">
                                                                <span class="badge rounded-pill bg-secondary p-2">
                                                                    <i class="fas fa-info-circle"></i>
                                                                </span>
                                                            </div>
                                                            <div>No hay acciones recientes.</div>
                                                        </li>
                                                        {% endif %}
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Pestaña de Favoritos -->
                                <div class="tab-pane fade profile-tab-content" id="favorites" role="tabpanel" aria-labelledby="favorites-tab">
                                    <div class="d-flex justify-content-between align-items-center mb-4">
                                        <h3>Hongos favoritos</h3>
                                    </div>
                                    
                                    {% if user_favorites is defined and user_favorites|length > 0 %}
                                        <div class="row row-cols-1 row-cols-md-2 g-4">
                                            {% for fungi in user_favorites %}
                                            <div class="col">
                                                <div class="card bg-dark border-secondary h-100" data-aos="fade-up" data-aos-delay="{{ loop.index * 50 }}">
                                                    <div class="row g-0">
                                                        <div class="col-4">
                                                            <img src="{{ fungi.image_url|default('/assets/images/default-fungi.jpg') }}" 
                                                                 class="img-fluid rounded-start h-100 w-100 object-fit-cover" 
                                                                 alt="{{ fungi.name|default('Hongo') }}">
                                                        </div>
                                                        <div class="col-8">
                                                            <div class="card-body">
                                                                <h5 class="card-title">{{ fungi.name|default('Hongo desconocido') }}</h5>
                                                                <p class="card-text text-muted">{{ fungi.common_name|default('Sin nombre común') }}</p>
                                                                <div class="d-flex justify-content-between align-items-center">
                                                                    <a href="/fungi/{{ fungi.id }}" class="btn btn-sm btn-outline-primary">
                                                                        <i class="fas fa-info-circle me-1"></i> Ver detalles
                                                                    </a>
                                                                    {% if is_own_profile %}
                                                                    <button class="btn btn-sm btn-outline-danger remove-favorite" data-id="{{ fungi.id }}">
                                                                        <i class="fas fa-trash me-1"></i> Eliminar
                                                                    </button>
                                                                    {% endif %}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    {% else %}
                                        <div class="alert alert-info" role="alert">
                                            <i class="fas fa-info-circle me-2"></i> No has marcado ningún hongo como favorito.
                                        </div>
                                        <a href="/" class="btn btn-primary" data-aos="fade-up">
                                            <i class="fas fa-search me-1"></i> Explorar hongos
                                        </a>
                                    {% endif %}
                                </div>

                                <!-- Pestaña de Configuración -->
                                {% if is_own_profile %}
                                <div class="tab-pane fade profile-tab-content" id="settings" role="tabpanel" aria-labelledby="settings-tab">
                                    <h3 class="mb-4">Configuración de la cuenta</h3>
                                    
                                    <div class="card mb-4" data-aos="fade-up">
                                        <div class="card-header profile-card-header">
                                            <i class="fas fa-lock me-2"></i> Seguridad
                                        </div>
                                        <div class="card-body">
                                            <form id="passwordForm">
                                                <div class="mb-3">
                                                    <label for="current_password" class="form-label">Contraseña actual</label>
                                                    <input type="password" class="form-control" id="current_password" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="new_password" class="form-label">Nueva contraseña</label>
                                                    <input type="password" class="form-control" id="new_password" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="confirm_password" class="form-label">Confirmar contraseña</label>
                                                    <input type="password" class="form-control" id="confirm_password" required>
                                                </div>
                                                <button type="submit" class="btn btn-primary">
                                                    <i class="fas fa-save me-1"></i> Cambiar contraseña
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                    <div class="card" data-aos="fade-up" data-aos-delay="200">
                                        <div class="card-header profile-card-header text-danger">
                                            <i class="fas fa-exclamation-triangle me-2"></i> Zona de peligro
                                        </div>
                                        <div class="card-body">
                                            <p class="text-danger">La siguiente accion es irreversible. Procede con precaución.</p>
                                            <div class="d-flex flex-column gap-3">
                                                <button id="deleteAccount" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteAccountModal">
                                                    <i class="fas fa-user-slash me-1"></i> Eliminar mi cuenta
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer>
        {% include 'components/footer.twig' %}
    </footer>

    <!-- Modal de edición de perfil -->
    {% if is_own_profile %}
    <div class="modal fade" id="editProfileModal" tabindex="-1" aria-labelledby="editProfileModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editProfileModalLabel"><i class="fas fa-user-edit me-2"></i>Editar perfil</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="profileForm">
                        <div class="mb-3">
                            <label for="username" class="form-label">Nombre de usuario</label>
                            <input type="text" class="form-control" id="username" value="{{ user.username }}" disabled>
                            <small class="text-muted">El nombre de usuario no se puede cambiar.</small>
                        </div>
                        <div class="mb-3">
                            <label for="avatar" class="form-label">Avatar</label>
                            <input type="file" class="form-control" id="avatar" accept="image/*">
                        </div>
                        <div class="mb-3">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" value="{{ user.email }}">
                        </div>
                        <div class="mb-3">
                            <label for="bio" class="form-label">Biografía</label>
                            <textarea class="form-control" id="bio" rows="3">{{ user.bio }}</textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="location" class="form-label">Ubicación</label>
                                <input type="text" class="form-control" id="location" value="{{ user.location }}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="website" class="form-label">Sitio web</label>
                                <input type="url" class="form-control" id="website" value="{{ user.website }}">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="phone" class="form-label">Teléfono</label>
                            <input type="tel" class="form-control" id="phone" value="{{ user.phone }}">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="saveProfile">
                        <i class="fas fa-save me-1"></i> Guardar cambios
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de confirmación para eliminar cuenta -->
    <div class="modal fade" id="deleteAccountModal" tabindex="-1" aria-labelledby="deleteAccountModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-danger" id="deleteAccountModalLabel">
                        <i class="fas fa-exclamation-triangle me-2"></i>Eliminar cuenta
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>¿Estás seguro de que deseas eliminar tu cuenta? Esta acción no se puede deshacer y perderás todos tus datos.</p>
                    <div class="mb-3">
                        <label for="delete_confirmation" class="form-label">Escribe "ELIMINAR" para confirmar:</label>
                        <input type="text" class="form-control" id="delete_confirmation" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteAccount" disabled>
                        <i class="fas fa-user-slash me-1"></i> Eliminar permanentemente
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Scripts -->
    <script src="/assets/lib/jquery.min.js"></script>
    <script src="/assets/lib/twbs/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    
    <script>
        // Inicializar AOS y tooltips
        AOS.init({
            duration: 800,
            easing: 'ease-in-out',
            once: true
        });
        
        // Tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });
        
        {% if is_own_profile %}
        // Código para usuarios autenticados
        document.getElementById('delete_confirmation').addEventListener('input', function() {
            const deleteBtn = document.getElementById('confirmDeleteAccount');
            deleteBtn.disabled = this.value !== 'ELIMINAR';
        });
        
        // Guardar perfil
        document.getElementById('saveProfile').addEventListener('click', function() {
            const formData = new FormData();
            formData.append('email', document.getElementById('email').value);
            formData.append('bio', document.getElementById('bio').value);
            formData.append('location', document.getElementById('location').value);
            
            const avatarInput = document.getElementById('avatar');
            if (avatarInput.files.length > 0) {
                formData.append('avatar', avatarInput.files[0]);
            }
            
            // Simulación
            console.log('Actualizando perfil...');
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('editProfileModal'));
            modal.hide();
            
            alert('Perfil actualizado correctamente');
        });
        
        // Eliminar favorito
        document.querySelectorAll('.remove-favorite').forEach(button => {
            button.addEventListener('click', function() {
                const fungiId = this.getAttribute('data-id');
                console.log('Eliminando favorito con ID:', fungiId);
                this.closest('.col-md-6').remove();
            });
        });
        {% endif %}
    </script>
</body>
</html>

<style>
    .profile-header {
        background: linear-gradient(135deg, #2c3e50, #4a5568);
        padding: 2rem 0;
        margin-bottom: 2rem;
        border-radius: 0 0 15px 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1) !important;
    }
</style>
