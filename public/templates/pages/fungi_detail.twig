<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ fungi.name|default('Hongo')|title|replace({'-': ' '}) }}</title>
    
    {% set styles = [
        '/assets/lib/twbs/bootstrap/dist/css/bootstrap.min.css',
        '/assets/styles/generic.css',
        '/assets/styles/components/navbar.css', 
        '/assets/styles/components/footer.css',
        '/assets/lib/fontawesome/fontawesome-free-6.4.0-web/css/all.min.css'
    ] %}

    {% for style in styles %}
        <link rel="stylesheet" href="{{ style }}">
    {% endfor %}

    <!-- CSS mínimo - solo lo imprescindible que Bootstrap no puede hacer -->
    <style>
        .hero-img {
            height: 350px;
            object-fit: cover;
        }
        
        .thumb-img {
            width: 70px;
            height: 70px;
            object-fit: cover;
        }
    </style>
</head>
<body class="bg-dark text-light">
    <header>
        {% include 'components/navbar.twig' %}
    </header>

    <main class="pb-5">
        <!-- Hero section -->
        <div class="position-relative mb-4">
            <img id="mainHeroImage" src="{{ fungi.image_urls|split(',')|first }}" alt="{{ fungi.name }}" class="hero-img w-100">
            
            <div class="position-absolute bottom-0 start-0 w-100 p-3" 
                 style="background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.4) 50%, transparent 100%);">
                <div class="container">
                    <h1 class="display-5 fw-bold text-white mb-0">{{ fungi.name|default('Hongo')|title|replace({'-': ' '}) }}</h1>
                    <p class="lead fst-italic text-white-50 mb-2">{{ fungi.latin_name }}</p>
                    
                    <div class="d-flex flex-wrap gap-2 mb-2">
                        <span class="badge {% if fungi.edibility == 'comestible' %}bg-success{% elseif fungi.edibility == 'venenoso' %}bg-danger{% else %}bg-warning text-dark{% endif %}">
                            <i class="fas {% if fungi.edibility == 'comestible' %}fa-utensils{% elseif fungi.edibility == 'venenoso' %}fa-skull{% else %}fa-exclamation-triangle{% endif %} me-1"></i>
                            {{ fungi.edibility|default('Desconocido')|title }}
                        </span>
                        
                        {% if fungi.common_name is defined and fungi.common_name %}
                            <span class="badge bg-primary">
                                <i class="fas fa-tag me-1"></i> {{ fungi.common_name }}
                            </span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row g-4">
                <!-- Columna principal (izquierda) -->
                <div class="col-lg-8">
                    <!-- Galería de imágenes -->
                    <div class="card bg-secondary mb-4">
                        <div class="card-header bg-dark">
                            <i class="fas fa-images text-primary me-2"></i>
                            <span class="fw-bold">Galería</span>
                        </div>
                        <div class="card-body bg-secondary py-3">
                            <div class="d-flex flex-nowrap overflow-auto gap-2 pb-2">
                                {% if fungi.image_urls is defined and fungi.image_urls %}
                                    {% set images = fungi.image_urls|split(',') %}
                                    {% for image in images %}
                                        <img src="{{ image }}" alt="{{ fungi.name }} - Imagen {{ loop.index }}" 
                                             class="thumb-img rounded border {% if loop.first %}border-primary{% else %}border-secondary{% endif %}"
                                             onclick="updateHeroImage('{{ image }}', {{ loop.index0 }})">
                                    {% endfor %}
                                {% else %}
                                    <p class="text-muted mb-0">No hay imágenes disponibles</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Sistema de pestañas -->
                    <div class="card bg-secondary overflow-hidden mb-4">
                        <div class="card-header p-0 bg-dark">
                            <ul class="nav nav-tabs card-header-tabs">
                                <li class="nav-item">
                                    <button class="nav-link text-white active" id="details-tab" data-bs-toggle="tab" data-bs-target="#details-content">
                                        <i class="fas fa-info-circle me-1"></i> Detalles
                                    </button>
                                </li>
                                <li class="nav-item">
                                    <button class="nav-link text-white" id="habitat-tab" data-bs-toggle="tab" data-bs-target="#habitat-content">
                                        <i class="fas fa-tree me-1"></i> Hábitat
                                    </button>
                                </li>
                                <li class="nav-item">
                                    <button class="nav-link text-white" id="taxonomy-tab" data-bs-toggle="tab" data-bs-target="#taxonomy-content">
                                        <i class="fas fa-sitemap me-1"></i> Taxonomía
                                    </button>
                                </li>
                                {% if fungi.observations is defined and fungi.observations %}
                                <li class="nav-item">
                                    <button class="nav-link text-white" id="notes-tab" data-bs-toggle="tab" data-bs-target="#notes-content">
                                        <i class="fas fa-sticky-note me-1"></i> Observaciones
                                    </button>
                                </li>
                                {% endif %}
                            </ul>
                        </div>
                        <div class="card-body p-0">
                            <div class="tab-content">
                                <!-- Pestaña de Detalles -->
                                <div class="tab-pane fade show active p-3" id="details-content">
                                    <div class="row g-3">
                                        {% if fungi.cap is defined and fungi.cap %}
                                        <div class="col-md-6">
                                            <div class="d-flex p-2 h-100 bg-dark bg-opacity-25 rounded">
                                                <div class="rounded-circle bg-dark d-flex align-items-center justify-content-center me-3" style="width:46px;height:46px">
                                                    <i class="fas fa-hat-wizard text-primary"></i>
                                                </div>
                                                <div>
                                                    <h6 class="mb-1 fw-bold">Sombrero</h6>
                                                    <p class="mb-0 small">{{ fungi.cap }}</p>
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}
                                        
                                        {% if fungi.gills is defined and fungi.gills %}
                                        <div class="col-md-6">
                                            <div class="d-flex p-2 h-100 bg-dark bg-opacity-25 rounded">
                                                <div class="rounded-circle bg-dark d-flex align-items-center justify-content-center me-3" style="width:46px;height:46px">
                                                    <i class="fas fa-align-center text-primary"></i>
                                                </div>
                                                <div>
                                                    <h6 class="mb-1 fw-bold">Láminas</h6>
                                                    <p class="mb-0 small">{{ fungi.gills }}</p>
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}
                                        
                                        {% if fungi.stem is defined and fungi.stem %}
                                        <div class="col-md-6">
                                            <div class="d-flex p-2 h-100 bg-dark bg-opacity-25 rounded">
                                                <div class="rounded-circle bg-dark d-flex align-items-center justify-content-center me-3" style="width:46px;height:46px">
                                                    <i class="fas fa-grip-lines-vertical text-primary"></i>
                                                </div>
                                                <div>
                                                    <h6 class="mb-1 fw-bold">Pie</h6>
                                                    <p class="mb-0 small">{{ fungi.stem }}</p>
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}
                                        
                                        {% if fungi.flesh is defined and fungi.flesh %}
                                        <div class="col-md-6">
                                            <div class="d-flex p-2 h-100 bg-dark bg-opacity-25 rounded">
                                                <div class="rounded-circle bg-dark d-flex align-items-center justify-content-center me-3" style="width:46px;height:46px">
                                                    <i class="fas fa-bacon text-primary"></i>
                                                </div>
                                                <div>
                                                    <h6 class="mb-1 fw-bold">Carne</h6>
                                                    <p class="mb-0 small">{{ fungi.flesh }}</p>
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <!-- Pestaña de Hábitat -->
                                <div class="tab-pane fade p-3" id="habitat-content">
                                    <div class="d-flex mb-3">
                                        <div class="rounded-circle bg-dark d-flex align-items-center justify-content-center me-3" style="width:46px;height:46px">
                                            <i class="fas fa-mountain text-primary"></i>
                                        </div>
                                        <div>
                                            <h6 class="mb-1 fw-bold">Hábitat</h6>
                                            <p class="mb-0">{{ fungi.habitat|default('No hay información disponible') }}</p>
                                        </div>
                                    </div>
                                    
                                    <div class="d-flex">
                                        <div class="rounded-circle bg-dark d-flex align-items-center justify-content-center me-3" style="width:46px;height:46px">
                                            <i class="fas fa-calendar-alt text-primary"></i>
                                        </div>
                                        <div>
                                            <h6 class="mb-1 fw-bold">Temporada</h6>
                                            <p class="mb-0">{{ fungi.season|default('No hay información disponible') }}</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Pestaña de Taxonomía -->
                                <div class="tab-pane fade p-3" id="taxonomy-content">
                                    <ul class="list-group list-group-flush bg-transparent">
                                        {% if fungi.kingdom is defined and fungi.kingdom %}
                                        <li class="list-group-item bg-transparent d-flex px-0">
                                            <div class="rounded-circle bg-dark d-flex align-items-center justify-content-center me-3" style="width:40px;height:40px">
                                                <i class="fas fa-crown text-primary"></i>
                                            </div>
                                            <div>
                                                <small class="text-muted d-block">Reino</small>
                                                <span>{{ fungi.kingdom }}</span>
                                            </div>
                                        </li>
                                        {% endif %}
                                        
                                        {% if fungi.phylum is defined and fungi.phylum %}
                                        <li class="list-group-item bg-transparent d-flex px-0">
                                            <div class="rounded-circle bg-dark d-flex align-items-center justify-content-center me-3" style="width:40px;height:40px">
                                                <i class="fas fa-layer-group text-primary"></i>
                                            </div>
                                            <div>
                                                <small class="text-muted d-block">Filo</small>
                                                <span>{{ fungi.phylum }}</span>
                                            </div>
                                        </li>
                                        {% endif %}
                                        
                                        {% if fungi.class is defined and fungi.class %}
                                        <li class="list-group-item bg-transparent d-flex px-0">
                                            <div class="rounded-circle bg-dark d-flex align-items-center justify-content-center me-3" style="width:40px;height:40px">
                                                <i class="fas fa-cubes text-primary"></i>
                                            </div>
                                            <div>
                                                <small class="text-muted d-block">Clase</small>
                                                <span>{{ fungi.class }}</span>
                                            </div>
                                        </li>
                                        {% endif %}
                                        
                                        {% if fungi.order is defined and fungi.order %}
                                        <li class="list-group-item bg-transparent d-flex px-0">
                                            <div class="rounded-circle bg-dark d-flex align-items-center justify-content-center me-3" style="width:40px;height:40px">
                                                <i class="fas fa-stream text-primary"></i>
                                            </div>
                                            <div>
                                                <small class="text-muted d-block">Orden</small>
                                                <span>{{ fungi.order }}</span>
                                            </div>
                                        </li>
                                        {% endif %}
                                        
                                        {% if fungi.family is defined and fungi.family %}
                                        <li class="list-group-item bg-transparent d-flex px-0">
                                            <div class="rounded-circle bg-dark d-flex align-items-center justify-content-center me-3" style="width:40px;height:40px">
                                                <i class="fas fa-users text-primary"></i>
                                            </div>
                                            <div>
                                                <small class="text-muted d-block">Familia</small>
                                                <span>{{ fungi.family }}</span>
                                            </div>
                                        </li>
                                        {% endif %}
                                        
                                        {% if fungi.genus is defined and fungi.genus %}
                                        <li class="list-group-item bg-transparent d-flex px-0">
                                            <div class="rounded-circle bg-dark d-flex align-items-center justify-content-center me-3" style="width:40px;height:40px">
                                                <i class="fas fa-dna text-primary"></i>
                                            </div>
                                            <div>
                                                <small class="text-muted d-block">Género</small>
                                                <span>{{ fungi.genus }}</span>
                                            </div>
                                        </li>
                                        {% endif %}
                                        
                                        {% if fungi.species is defined and fungi.species %}
                                        <li class="list-group-item bg-transparent d-flex px-0 border-0">
                                            <div class="rounded-circle bg-dark d-flex align-items-center justify-content-center me-3" style="width:40px;height:40px">
                                                <i class="fas fa-fingerprint text-primary"></i>
                                            </div>
                                            <div>
                                                <small class="text-muted d-block">Especie</small>
                                                <span>{{ fungi.species }}</span>
                                            </div>
                                        </li>
                                        {% endif %}
                                    </ul>
                                </div>
                                
                                <!-- Pestaña de Observaciones -->
                                {% if fungi.observations is defined and fungi.observations %}
                                <div class="tab-pane fade p-3" id="notes-content">
                                    <div class="d-flex">
                                        <div class="rounded-circle bg-dark d-flex align-items-center justify-content-center me-3" style="width:46px;height:46px">
                                            <i class="fas fa-sticky-note text-primary"></i>
                                        </div>
                                        <div>
                                            <h6 class="mb-2 fw-bold">Observaciones</h6>
                                            <p class="mb-0 fst-italic">{{ fungi.observations }}</p>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Columna lateral (derecha) -->
                <div class="col-lg-4">
                    <!-- Acciones -->
                    {% if is_logged_in %}
                    <div class="card bg-secondary mb-4">
                        <div class="card-header bg-dark">
                            <i class="fas fa-star text-primary me-2"></i>
                            <span class="fw-bold">Acciones</span>
                        </div>
                        <div class="card-body text-center">
                            <div class="d-grid gap-2">
                                <button id="likeButton" onclick="toggleLike('{{ fungi.id }}')" 
                                    class="btn {% if fungi.liked %}btn-danger{% else %}btn-outline-danger{% endif %} d-flex align-items-center justify-content-center">
                                    <i class="fas fa-heart me-2"></i>
                                    <span id="likeText">{% if fungi.liked %}Quitar me gusta{% else %}Me gusta{% endif %}</span>
                                </button>
                                
                                <button id="favoriteButton" onclick="toggleFavorite('{{ fungi.id }}')" 
                                    class="btn {% if fungi.favorite %}btn-warning{% else %}btn-outline-warning{% endif %} d-flex align-items-center justify-content-center">
                                    <i class="fas fa-star me-2"></i>
                                    <span>Favorito</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Información adicional -->
                    <div class="card bg-secondary mb-4">
                        <div class="card-header bg-dark">
                            <i class="fas fa-exclamation-circle text-primary me-2"></i>
                            <span class="fw-bold">Información importante</span>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-{% if fungi.edibility == 'comestible' %}success{% elseif fungi.edibility == 'venenoso' %}danger{% else %}warning{% endif %} mb-0">
                                <div class="d-flex">
                                    <div class="me-3 fs-3">
                                        <i class="fas {% if fungi.edibility == 'comestible' %}fa-utensils{% elseif fungi.edibility == 'venenoso' %}fa-skull-crossbones{% else %}fa-exclamation-triangle{% endif %}"></i>
                                    </div>
                                    <div>
                                        <h5>{{ fungi.edibility|default('Desconocido')|title }}</h5>
                                        <p class="mb-0 small">{% if fungi.edibility == 'comestible' %}Este hongo es comestible. Sin embargo, siempre consulte con un experto antes de consumir cualquier hongo silvestre.{% elseif fungi.edibility == 'venenoso' %}¡ADVERTENCIA! Este hongo es venenoso y no debe ser consumido bajo ninguna circunstancia.{% else %}Se desconoce si este hongo es comestible. Por seguridad, no debe ser consumido.{% endif %}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {% if fungi.similar_species is defined and fungi.similar_species %}
                    <div class="card bg-secondary mb-4">
                        <div class="card-header bg-dark">
                            <i class="fas fa-exchange-alt text-primary me-2"></i>
                            <span class="fw-bold">Especies similares</span>
                        </div>
                        <div class="card-body">
                            <p class="mb-0 small">{{ fungi.similar_species }}</p>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Modal de imagen ampliada -->
        <div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-xl">
                <div class="modal-content bg-dark">
                    <div class="modal-header border-secondary">
                        <h5 class="modal-title">{{ fungi.name|default('Hongo')|title|replace({'-': ' '}) }}</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body text-center position-relative p-0">
                        <img id="modalImage" src="" alt="{{ fungi.name }}" class="img-fluid">
                        
                        <button id="prevImageBtn" class="btn btn-dark position-absolute top-50 start-0 translate-middle-y rounded-circle ms-3">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button id="nextImageBtn" class="btn btn-dark position-absolute top-50 end-0 translate-middle-y rounded-circle me-3">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer>
        {% include 'components/footer.twig' %}
    </footer>

    {% set scripts = [
        '/assets/lib/jquery.min.js',
        '/assets/lib/twbs/bootstrap/dist/js/bootstrap.bundle.min.js'
    ] %}

    {% for script in scripts %}
        <script src="{{ script }}"></script>
    {% endfor %}

    <script>
        // Variables globales
        let currentImageIndex = 0;
        const allImages = [
            {% if fungi.image_urls is defined and fungi.image_urls %}
                {% set images = fungi.image_urls|split(',') %}
                {% for image in images %}
                    "{{ image }}"{% if not loop.last %},{% endif %}
                {% endfor %}
            {% endif %}
        ];
        
        // Inicializar tooltips de Bootstrap
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
        
        // Función para actualizar la imagen hero
        function updateHeroImage(src, index) {
            document.getElementById('mainHeroImage').src = src;
            currentImageIndex = index;
            
            // Actualizar clase activa en miniaturas
            const thumbnails = document.querySelectorAll('.thumb-img');
            thumbnails.forEach((thumb, i) => {
                if (i === index) {
                    thumb.classList.add('border-primary');
                    thumb.classList.remove('border-secondary');
                } else {
                    thumb.classList.remove('border-primary');
                    thumb.classList.add('border-secondary');
                }
            });
            
            // Abrir modal al hacer clic en la imagen principal
            document.getElementById('mainHeroImage').onclick = function() {
                openImageModal(src, index);
            };
        }
        
        // Establecer imagen principal como clickeable
        document.getElementById('mainHeroImage').style.cursor = 'pointer';
        document.getElementById('mainHeroImage').onclick = function() {
            openImageModal(this.src, 0);
        };
        
        // Función para abrir modal
        function openImageModal(src, index) {
            const modal = new bootstrap.Modal(document.getElementById('imageModal'));
            document.getElementById('modalImage').src = src;
            currentImageIndex = index;
            modal.show();
        }
        
        // Navegación en modal
        document.getElementById('prevImageBtn').addEventListener('click', function() {
            if (allImages.length <= 1) return;
            currentImageIndex = (currentImageIndex - 1 + allImages.length) % allImages.length;
            document.getElementById('modalImage').src = allImages[currentImageIndex];
        });
        
        document.getElementById('nextImageBtn').addEventListener('click', function() {
            if (allImages.length <= 1) return;
            currentImageIndex = (currentImageIndex + 1) % allImages.length;
            document.getElementById('modalImage').src = allImages[currentImageIndex];
        });
        
        // Navegación con teclado
        document.addEventListener('keydown', function(event) {
            const modal = document.getElementById('imageModal');
            if (!modal.classList.contains('show')) return;
            
            if (event.key === 'ArrowLeft') {
                document.getElementById('prevImageBtn').click();
            } else if (event.key === 'ArrowRight') {
                document.getElementById('nextImageBtn').click();
            }
        });
        
        {% if is_logged_in %}
        function toggleLike(fungiId) {
            const likeButton = document.getElementById('likeButton');
            const isLiked = likeButton.classList.contains('btn-danger');
            
            // Optimistic UI update
            if (isLiked) {
                likeButton.classList.replace('btn-danger', 'btn-outline-danger');
                document.getElementById('likeText').textContent = 'Me gusta';
            } else {
                likeButton.classList.replace('btn-outline-danger', 'btn-danger');
                document.getElementById('likeText').textContent = 'Quitar me gusta';
            }
            
            // API call
            fetch(`/api/fungi/${fungiId}/like`, {
                method: isLiked ? 'DELETE' : 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'same-origin'
            })
            .then(response => {
                if (!response.ok) {
                    // Revert UI change if API call fails
                    if (isLiked) {
                        likeButton.classList.replace('btn-outline-danger', 'btn-danger');
                        document.getElementById('likeText').textContent = 'Quitar me gusta';
                    } else {
                        likeButton.classList.replace('btn-danger', 'btn-outline-danger');
                        document.getElementById('likeText').textContent = 'Me gusta';
                    }
                    throw new Error('Error en la respuesta del servidor');
                }
                return response.json();
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }
        
        function toggleFavorite(fungiId) {
            const favoriteButton = document.getElementById('favoriteButton');
            const isFavorite = favoriteButton.classList.contains('btn-warning');
            
            // Optimistic UI update
            if (isFavorite) {
                favoriteButton.classList.replace('btn-warning', 'btn-outline-warning');
            } else {
                favoriteButton.classList.replace('btn-outline-warning', 'btn-warning');
            }
            
            // API call
            fetch(`/api/user/favorites/${fungiId}`, {
                method: isFavorite ? 'DELETE' : 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'same-origin'
            })
            .then(response => {
                if (!response.ok) {
                    // Revert UI change if API call fails
                    if (isFavorite) {
                        favoriteButton.classList.replace('btn-outline-warning', 'btn-warning');
                    } else {
                        favoriteButton.classList.replace('btn-warning', 'btn-outline-warning');
                    }
                    throw new Error('Error en la respuesta del servidor');
                }
                return response.json();
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }
        {% endif %}
    </script>
</body>
</html> 