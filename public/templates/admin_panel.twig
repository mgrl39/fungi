{% extends 'base.twig' %}

{% block title %}Panel de Administración{% endblock %}

{% block content %}
    {% if not is_granted('ROLE_ADMIN') %}
        <div class="alert alert-danger">
            <h3>Acceso Denegado</h3>
            <p>No tienes permiso para acceder a esta página. Por favor, inicia sesión como administrador.</p>
            <a href="{{ path('login') }}" class="btn btn-primary">Iniciar Sesión</a>
        </div>
    {% else %}
        <div class="container mt-4">
            <h1>Panel de Administración de Datos</h1>
            
            <!-- Menú de navegación -->
            <ul class="nav nav-tabs mb-4">
                <li class="nav-item">
                    <a class="nav-link active" id="data-tab" data-toggle="tab" href="#data" role="tab">Datos</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="settings-tab" data-toggle="tab" href="#settings" role="tab">Configuración</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="log-tab" data-toggle="tab" href="#log" role="tab">Registro de Actividades</a>
                </li>
            </ul>
            
            <!-- Contenido de las pestañas -->
            <div class="tab-content">
                <!-- Pestaña de Datos -->
                <div class="tab-pane fade show active" id="data" role="tabpanel">
                    <div class="d-flex justify-content-between mb-3">
                        <h3>Datos de Scraping</h3>
                        <div>
                            <button type="button" class="btn btn-success" data-toggle="modal" data-target="#addDataModal">
                                <i class="fas fa-plus"></i> Añadir Nuevo
                            </button>
                            <button type="button" class="btn btn-primary" id="refreshData">
                                <i class="fas fa-sync"></i> Actualizar
                            </button>
                        </div>
                    </div>
                    
                    <!-- Filtros -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5>Filtros</h5>
                        </div>
                        <div class="card-body">
                            <form id="filterForm" class="row">
                                <div class="col-md-3 mb-2">
                                    <label for="dateFilter">Fecha</label>
                                    <input type="date" id="dateFilter" class="form-control">
                                </div>
                                <div class="col-md-3 mb-2">
                                    <label for="sourceFilter">Fuente</label>
                                    <select id="sourceFilter" class="form-control">
                                        <option value="">Todas</option>
                                        {% for source in sources %}
                                            <option value="{{ source.id }}">{{ source.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-3 mb-2">
                                    <label for="statusFilter">Estado</label>
                                    <select id="statusFilter" class="form-control">
                                        <option value="">Todos</option>
                                        <option value="active">Activo</option>
                                        <option value="inactive">Inactivo</option>
                                    </select>
                                </div>
                                <div class="col-md-3 d-flex align-items-end mb-2">
                                    <button type="submit" class="btn btn-info w-100">Aplicar Filtros</button>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <!-- Tabla de datos -->
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered">
                            <thead class="thead-dark">
                                <tr>
                                    <th>ID</th>
                                    <th>Título</th>
                                    <th>Fuente</th>
                                    <th>URL</th>
                                    <th>Fecha</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in scraped_data %}
                                <tr>
                                    <td>{{ item.id }}</td>
                                    <td>{{ item.title }}</td>
                                    <td>{{ item.source }}</td>
                                    <td>
                                        <a href="{{ item.url }}" target="_blank" class="text-truncate d-inline-block" style="max-width: 200px;">
                                            {{ item.url }}
                                        </a>
                                    </td>
                                    <td>{{ item.date|date('d/m/Y') }}</td>
                                    <td>
                                        <span class="badge badge-{{ item.status == 'active' ? 'success' : 'secondary' }}">
                                            {{ item.status == 'active' ? 'Activo' : 'Inactivo' }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="btn-group">
                                            <button type="button" class="btn btn-sm btn-info view-data" 
                                                    data-id="{{ item.id }}" data-toggle="modal" data-target="#viewDataModal">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-warning edit-data" 
                                                    data-id="{{ item.id }}" data-toggle="modal" data-target="#editDataModal">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-danger delete-data" 
                                                    data-id="{{ item.id }}" data-toggle="modal" data-target="#deleteDataModal">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="7" class="text-center">No se encontraron datos</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Paginación -->
                    {% if total_pages > 1 %}
                    <nav aria-label="Navegación de páginas">
                        <ul class="pagination justify-content-center">
                            <li class="page-item {{ current_page == 1 ? 'disabled' : '' }}">
                                <a class="page-link" href="{{ path('admin_panel', {page: current_page - 1}) }}">Anterior</a>
                            </li>
                            
                            {% for i in 1..total_pages %}
                                <li class="page-item {{ current_page == i ? 'active' : '' }}">
                                    <a class="page-link" href="{{ path('admin_panel', {page: i}) }}">{{ i }}</a>
                                </li>
                            {% endfor %}
                            
                            <li class="page-item {{ current_page == total_pages ? 'disabled' : '' }}">
                                <a class="page-link" href="{{ path('admin_panel', {page: current_page + 1}) }}">Siguiente</a>
                            </li>
                        </ul>
                    </nav>
                    {% endif %}
                </div>
                
                <!-- Pestaña de Configuración -->
                <div class="tab-pane fade" id="settings" role="tabpanel">
                    <h3 class="mb-4">Configuración de Scraping</h3>
                    
                    <div class="card">
                        <div class="card-header">
                            <h5>Fuentes de Datos</h5>
                        </div>
                        <div class="card-body">
                            <form id="scrapingSettingsForm">
                                <div class="form-group">
                                    <label for="scrapeFrequency">Frecuencia de Scraping</label>
                                    <select class="form-control" id="scrapeFrequency">
                                        <option value="hourly">Cada hora</option>
                                        <option value="daily">Diario</option>
                                        <option value="weekly">Semanal</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>Fuentes Activas</label>
                                    {% for source in scrape_sources %}
                                    <div class="custom-control custom-switch">
                                        <input type="checkbox" class="custom-control-input" 
                                               id="source{{ source.id }}" {{ source.active ? 'checked' : '' }}>
                                        <label class="custom-control-label" for="source{{ source.id }}">
                                            {{ source.name }} - <small class="text-muted">{{ source.url }}</small>
                                        </label>
                                    </div>
                                    {% endfor %}
                                </div>
                                
                                <div class="form-group">
                                    <label for="newSourceUrl">Añadir Nueva Fuente</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="newSourceName" placeholder="Nombre de la fuente">
                                        <input type="url" class="form-control" id="newSourceUrl" placeholder="URL">
                                        <div class="input-group-append">
                                            <button class="btn btn-primary" type="button" id="addSourceBtn">Añadir</button>
                                        </div>
                                    </div>
                                </div>
                                
                                <button type="submit" class="btn btn-success">Guardar Configuración</button>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Pestaña de Registro -->
                <div class="tab-pane fade" id="log" role="tabpanel">
                    <h3 class="mb-4">Registro de Actividades</h3>
                    
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Fecha y Hora</th>
                                    <th>Usuario</th>
                                    <th>Acción</th>
                                    <th>Detalles</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for log in activity_logs %}
                                <tr>
                                    <td>{{ log.timestamp|date('d/m/Y H:i:s') }}</td>
                                    <td>{{ log.username }}</td>
                                    <td>{{ log.action }}</td>
                                    <td>{{ log.details }}</td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="4" class="text-center">No hay actividades registradas</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Modales -->
        {% include 'admin/modals/view_data_modal.twig' %}
        {% include 'admin/modals/edit_data_modal.twig' %}
        {% include 'admin/modals/add_data_modal.twig' %}
        {% include 'admin/modals/delete_data_modal.twig' %}
        
        <!-- Scripts específicos del panel de administración -->
        <script src="{{ asset('js/admin_panel.js') }}"></script>
    {% endif %}
{% endblock %}
